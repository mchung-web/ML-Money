<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ML Budget V4.7</title>
    <link rel="apple-touch-icon" id="dynamic-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body { background-color: #F2F2F7; font-family: -apple-system, sans-serif; overflow: hidden; height: 100dvh; margin: 0; }
        #root { height: 100dvh; }
        .ios-card { background: white; border-radius: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.04); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 12px); }
        
        /* ÂãïÁï´ÊïàÊûú */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Â∫ïÈÉ®ÂΩàÁ™ó */
        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); position: absolute; inset: 0; z-index: 100; display: flex; align-items: flex-end; }
        .modal-content { background: white; width: 100%; border-radius: 24px 24px 0 0; padding: 24px; padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        function App() {
            const [view, setView] = useState('input'); 
            const [amount, setAmount] = useState('0');
            const [isEditMode, setIsEditMode] = useState(false);
            const [showModal, setShowModal] = useState(false);
            const [newCatName, setNewCatName] = useState('');
            const [newCatEmoji, setNewCatEmoji] = useState('üí∞');

            // Êï∏ÊìöÊåÅ‰πÖÂåñ
            const [records, setRecords] = useState(() => JSON.parse(localStorage.getItem('ML_V47_DATA') || '[]'));
            const [categories, setCategories] = useState(() => {
                const saved = JSON.parse(localStorage.getItem('ML_V47_CATS'));
                return (saved && saved.length) ? saved : [
                    {n:'È§êÂª≥',i:'üçΩÔ∏è'},{n:'Êó•Áî®ÂìÅ',i:'üßª'},{n:'Ë∂ÖÂ∏Ç',i:'üõí'},
                    {n:'Â®õÊ®Ç',i:'üéÆ'},{n:'Ëªä',i:'üöó'},{n:'ÂÖ∂‰ªñ',i:'üí∞'}
                ];
            });
            const [selectedCat, setSelectedCat] = useState(categories[0]?.n);

            useEffect(() => { localStorage.setItem('ML_V47_DATA', JSON.stringify(records)); }, [records]);
            useEffect(() => { localStorage.setItem('ML_V47_CATS', JSON.stringify(categories)); }, [categories]);

            const handleSave = () => {
                if (amount === '0' || amount === '0.') return;
                const newRecord = { 
                    id: Date.now(), 
                    amount: parseFloat(amount), 
                    category: selectedCat, 
                    timestamp: Date.now(), 
                    dateStr: new Date().toLocaleDateString('zh-HK') 
                };
                setRecords([newRecord, ...records]);
                setAmount('0');
            };

            return (
                <div className="flex flex-col h-full max-w-md mx-auto relative bg-[#F2F2F7] text-gray-900">
                    {/* Header */}
                    <header className="flex-none pt-12 px-5 pb-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <span className="text-2xl">ü¶í</span>
                            <h1 className="text-xl font-black tracking-tight">ML Budget</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            {view === 'input' && (
                                <button onClick={() => setIsEditMode(!isEditMode)} className={`px-3 py-1 rounded-full text-[10px] font-black transition-all ${isEditMode ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-500'}`}>
                                    {isEditMode ? 'ÂÆåÊàê' : 'Á∑®ËºØÂàÜÈ°û'}
                                </button>
                            )}
                            <span className="px-2 py-0.5 bg-white border text-[10px] font-bold rounded-lg shadow-sm">V4.7</span>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 px-4 overflow-hidden flex flex-col">
                        {view === 'input' && (
                            <div className="fade-in flex flex-col h-full">
                                <div className="flex-none ios-card p-5 text-right mb-3 border border-white">
                                    <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Spending (HKD)</div>
                                    <div className="text-5xl font-black tracking-tighter text-gray-900">
                                        <span className="text-2xl mr-1 text-orange-500 font-bold">$</span>{amount}
                                    </div>
                                </div>

                                <div className="flex-none mb-3 overflow-x-auto no-scrollbar">
                                    <div className="grid grid-cols-4 gap-2 min-w-full">
                                        {categories.map(cat => (
                                            <button key={cat.n} 
                                                onClick={() => isEditMode ? setCategories(categories.filter(c => c.n !== cat.n)) : setSelectedCat(cat.n)}
                                                className={`relative py-3 rounded-2xl border transition-all flex flex-col items-center ${selectedCat === cat.n && !isEditMode ? 'bg-gray-900 text-white shadow-lg scale-105' : 'bg-white text-gray-500 border-transparent shadow-sm'}`}>
                                                {isEditMode && <div className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs font-bold">√ó</div>}
                                                <span className="text-2xl mb-1">{cat.i}</span>
                                                <span className="text-[10px] font-black">{cat.n}</span>
                                            </button>
                                        ))}
                                        <button onClick={() => setShowModal(true)} className="py-3 rounded-2xl border border-dashed border-gray-300 bg-gray-50 text-gray-400 flex flex-col items-center justify-center">
                                            <span className="text-xl">Ôºã</span>
                                            <span className="text-[10px] font-black">Êñ∞Â¢û</span>
                                        </button>
                                    </div>
                                </div>

                                <div className="grid grid-cols-3 gap-2 mb-3">
                                    {[1,2,3,4,5,6,7,8,9,'.',0].map(n => (
                                        <button key={n} onClick={() => setAmount(p => p==='0' && n!=='.'?String(n):p+n)} className="ios-card h-14 text-2xl font-black active:bg-gray-100 transition-colors">{n}</button>
                                    ))}
                                    <button onClick={() => setAmount('0')} className="ios-card h-14 text-2xl font-black text-red-500 active:bg-red-50">C</button>
                                </div>

                                <button onClick={handleSave} className="w-full bg-orange-500 text-white h-14 rounded-2xl font-black text-xl shadow-lg shadow-orange-200 active:scale-[0.98] transition-all">ÂÑ≤Â≠òÊîØÂá∫</button>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="fade-in h-full overflow-y-auto pb-32 no-scrollbar">
                                {records.length === 0 ? <EmptyState /> : records.map(r => (
                                    <HistoryRow key={r.id} record={r} categories={categories} onDelete={() => setRecords(records.filter(x => x.id !== r.id))} />
                                ))}
                            </div>
                        )}

                        {view === 'stats' && (
                            <div className="fade-in h-full overflow-y-auto pb-32 no-scrollbar">
                                <StatsView records={records} categories={categories} />
                            </div>
                        )}
                    </main>

                    {/* Modals & Nav */}
                    {showModal && (
                        <div className="modal-overlay" onClick={() => setShowModal(false)}>
                            <div className="modal-content" onClick={e => e.stopPropagation()}>
                                <h2 className="text-xl font-black mb-6">Êñ∞Â¢ûÊ∂àË≤ªÂàÜÈ°û</h2>
                                <div className="space-y-4">
                                    <input autoFocus className="w-full bg-gray-100 p-4 rounded-2xl font-bold text-lg outline-none border-2 border-transparent focus:border-orange-500 transition-all" placeholder="ÂàÜÈ°ûÂêçÁ®± (Â¶ÇÔºöÂíñÂï°)" value={newCatName} onChange={e => setNewCatName(e.target.value)} />
                                    <input className="w-full bg-gray-100 p-4 rounded-2xl text-3xl outline-none border-2 border-transparent focus:border-orange-500 transition-all" placeholder="ÂúñÁ§∫ (Emoji)" value={newCatEmoji} onChange={e => setNewCatEmoji(e.target.value)} />
                                    <button onClick={() => {
                                        if(!newCatName) return;
                                        setCategories([...categories, {n: newCatName, i: newCatEmoji}]);
                                        setNewCatName(''); setShowModal(false);
                                    }} className="w-full bg-black text-white py-4 rounded-2xl font-black text-lg">Âä†ÂÖ•ÂàóË°®</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <nav className="flex-none bg-white/80 backdrop-blur-xl border-t px-10 pt-3 flex justify-between absolute bottom-0 left-0 right-0 safe-pb shadow-2xl">
                        <TabBtn active={view==='input'} icon="‚ûï" label="Ë®òÂ∏≥" onClick={()=>setView('input')} />
                        <TabBtn active={view==='history'} icon="üìú" label="ÊòéÁ¥∞" onClick={()=>setView('history')} />
                        <TabBtn active={view==='stats'} icon="üìä" label="Áµ±Ë®à" onClick={()=>setView('stats')} />
                    </nav>
                </div>
            );
        }

        // --- Â≠êÁµÑ‰ª∂ ---

        function StatsView({ records, categories }) {
            const [offset, setOffset] = useState(0);
            const stats = useMemo(() => {
                const now = new Date();
                const d = new Date(now.getFullYear(), now.getMonth() + offset, 1);
                const start = new Date(d.getFullYear(), d.getMonth(), 1).getTime();
                const end = new Date(d.getFullYear(), d.getMonth() + 1, 0, 23, 59, 59).getTime();
                const filtered = records.filter(r => r.timestamp >= start && r.timestamp <= end);
                
                const total = filtered.reduce((s, r) => s + r.amount, 0);
                const count = filtered.length;
                const dailyAvg = total / (new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate());
                
                const catMap = filtered.reduce((acc, r) => {
                    acc[r.category] = (acc[r.category] || 0) + r.amount;
                    return acc;
                }, {});

                return { 
                    total, count, dailyAvg, 
                    catList: Object.entries(catMap).sort((a,b) => b[1] - a[1]),
                    label: `${d.getFullYear()}Âπ¥ ${d.getMonth() + 1}Êúà`
                };
            }, [offset, records]);

            return (
                <div className="space-y-4">
                    {/* Êúà‰ªΩÂàáÊèõ */}
                    <div className="flex items-center justify-between bg-white p-3 rounded-2xl shadow-sm">
                        <button onClick={() => setOffset(offset - 1)} className="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl text-orange-500 font-bold">‚óÄ</button>
                        <div className="text-center">
                            <div className="text-[10px] font-black text-gray-400 uppercase tracking-widest">Monthly Analysis</div>
                            <div className="font-black text-lg">{stats.label}</div>
                        </div>
                        <button onClick={() => setOffset(offset + 1)} className="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl text-orange-500 font-bold">‚ñ∂</button>
                    </div>

                    {/* Êï∏ÊìöÊ¶ÇË¶Ω */}
                    <div className="grid grid-cols-2 gap-3">
                        <div className="ios-card p-4 bg-gray-900 text-white">
                            <div className="text-[10px] font-bold text-gray-400 mb-1">Á∏ΩÊîØÂá∫</div>
                            <div className="text-2xl font-black">${stats.total.toLocaleString()}</div>
                        </div>
                        <div className="ios-card p-4">
                            <div className="text-[10px] font-bold text-gray-400 mb-1">Âπ≥Âùá/Êó•</div>
                            <div className="text-2xl font-black text-orange-500">${Math.round(stats.dailyAvg).toLocaleString()}</div>
                        </div>
                    </div>

                    {/* ÂàÜÈ°ûÊ∏ÖÂñÆ */}
                    <div className="ios-card p-5 space-y-6">
                        <div className="flex justify-between items-end">
                            <h3 className="font-black text-sm text-gray-400 uppercase tracking-widest">ÂàÜÈ°ûÊØèÊúàÁ∏ΩÈ°ç</h3>
                            <span className="text-[10px] font-bold px-2 py-1 bg-gray-100 rounded-lg">{stats.count} Á≠Ü‰∫§Êòì</span>
                        </div>
                        
                        {stats.catList.length > 0 ? stats.catList.map(([name, amt]) => {
                            const pct = ((amt / stats.total) * 100).toFixed(1);
                            const icon = categories.find(c => c.n === name)?.i || 'üí∞';
                            return (
                                <div key={name} className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <span className="text-xl">{icon}</span>
                                            <span className="font-black text-sm">{name}</span>
                                            <span className="text-[10px] font-bold text-gray-300">{pct}%</span>
                                        </div>
                                        <div className="font-black text-sm">${amt.toLocaleString()}</div>
                                    </div>
                                    <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                        <div className="bg-orange-500 h-full transition-all duration-500" style={{width: `${pct}%`}}></div>
                                    </div>
                                </div>
                            );
                        }) : <div className="text-center py-10 text-gray-300 font-bold">Êú¨ÊúàÁÑ°Êï∏Êìö</div>}
                    </div>
                </div>
            );
        }

        function HistoryRow({ record, categories, onDelete }) {
            const [x, setX] = useState(0);
            const icon = categories.find(c => c.n === record.category)?.i || 'üí∞';
            return (
                <div className="relative overflow-hidden mb-3 rounded-2xl group">
                    <div className="absolute inset-0 bg-red-500 flex justify-end items-center pr-6 text-white font-black" onClick={onDelete}>Âà™Èô§</div>
                    <div className="relative bg-white p-4 flex justify-between items-center transition-transform duration-200 shadow-sm"
                        style={{ transform: `translateX(${x}px)` }}
                        onTouchStart={e => this.start = e.touches[0].clientX}
                        onTouchMove={e => {
                            const diff = e.touches[0].clientX - this.start;
                            if (diff < 0) setX(diff);
                        }}
                        onTouchEnd={() => setX(x < -50 ? -80 : 0)}
                    >
                        <div className="flex items-center gap-4">
                            <div className="w-12 h-12 bg-gray-50 rounded-2xl flex items-center justify-center text-2xl">{icon}</div>
                            <div>
                                <div className="font-black text-gray-800">{record.category}</div>
                                <div className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">{record.dateStr}</div>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="font-black text-red-500 text-lg">-${record.amount.toLocaleString()}</div>
                            <div className="text-[8px] font-bold text-gray-300">HKD</div>
                        </div>
                    </div>
                </div>
            );
        }

        function TabBtn({ active, icon, label, onClick }) {
            return (
                <button onClick={onClick} className={`flex flex-col items-center transition-all ${active ? 'text-orange-500 scale-110' : 'text-gray-300'}`}>
                    <span className="text-2xl mb-1">{icon}</span>
                    <span className="text-[10px] font-black uppercase tracking-tighter">{label}</span>
                </button>
            );
        }

        function EmptyState() {
            return (
                <div className="h-full flex flex-col items-center justify-center text-gray-300 space-y-2">
                    <span className="text-6xl">üìù</span>
                    <span className="font-black">Â∞öÁÑ°‰ªª‰ΩïÊîØÂá∫Á¥ÄÈåÑ</span>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
